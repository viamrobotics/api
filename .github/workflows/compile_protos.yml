name: Compile Protos

concurrency:
  group: ${{ github.event.pull_request.id }}
  cancel-in-progress: true

on:
  pull_request:
    # branches:
    # - main

env:
  # guards against running this action on its own previous commit
  is-auto-commit:
  commit-message:
  commit-author:
  GRPC_WEB_VERSION: '1.5.0'

jobs:
  compile-protos:
    runs-on: ubuntu-latest
    env:
      CI_COMMIT_MESSAGE_PREFIX: Built new protos from
      CI_COMMIT_AUTHOR: github-actions
      LABEL_NAME: protos-compiled
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2
      - uses: actions/setup-node@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      # todo: cache download
      # todo: make sure there's nothing special about the grpc-web .deb in canon
      - name: grpc-web
        run: |
          wget --quiet https://github.com/grpc/grpc-web/releases/download/${{ env.GRPC_WEB_VERSION }}/protoc-gen-grpc-web-${{ env.GRPC_WEB_VERSION }}-linux-x86_64 -O protoc-gen-grpc-web
          chmod +x protoc-gen-grpc-web
          sudo mv protoc-gen-grpc-web /usr/local/bin
          which protoc-gen-grpc-web
      # Set environment variables based on the last commit
      - name: Set environment variable "commit-message"
        run: |
          echo "commit-message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV
          echo "commit-author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
      # If the last commit is an auto-generated commit from this workflow, we can exit early
      - name: Set environment variable "is-auto-commit"
        if: startsWith(env.commit-message, env.CI_COMMIT_MESSAGE_PREFIX) && env.commit-author == env.CI_COMMIT_AUTHOR
        run: echo "is-auto-commit=true" >> $GITHUB_ENV

      - uses: bufbuild/buf-setup-action@v1
        if: ${{ !env.is-auto-commit }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: arduino/setup-protoc@v1
        if: ${{ !env.is-auto-commit }}

      - name: Compile protos
        if: ${{ !env.is-auto-commit }}
        run: make dist/buf

      - name: commit + push
        if: ${{ !env.is-auto-commit }}
        run: |
          git add .
          git checkout -b ${{ github.event.pull_request.head.ref }}
          git status
          git config user.email github-actions@github.com
          git config user.name github-actions
          git commit -a -m "${{ env.CI_COMMIT_MESSAGE_PREFIX }} $(git rev-parse --short HEAD)"
          git push -u origin ${{ github.event.pull_request.head.ref }}

      # - name: Commit + Push
      #   if: ${{ !env.is-auto-commit }}
      #   uses: EndBug/add-and-commit@v9.0.0
      #   with:
      #     default_author: github_actions
      #     message: ${{ env.CI_COMMIT_MESSAGE_PREFIX }} ${{ steps.short_sha.outputs.short_sha }}
      #     push: true

      # - name: add back label
      #   if: ${{ !env.is-auto-commit }}
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: gh pr edit ${{ github.event.pull_request.number }} --add-label ${{ env.LABEL_NAME }}
